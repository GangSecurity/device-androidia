######################################################################
# ACRN GPT Image Generation
######################################################################

gptimage_size ?= {{{size}}}

ACRN_DATA_DIR = $(PRODUCT_OUT)/data_partition
ACRN_AND_DIR = $(ACRN_DATA_DIR)/android
ACRN_GPT_BIN = $(ACRN_AND_DIR)/android.img
ACRN_DATA_SIZE ?= {{{data_size}}}
MAKE_EXT4FS_ACRN = $(TARGET_DEVICE_DIR)/make_ext4fs

raw_config := none
raw_factory := none
tos_bin := none
raw_product := none
raw_odm := none
raw_acpi := none
raw_acpio := none

.PHONY: none
none: ;

.PHONY: $(INSTALLED_CONFIGIMAGE_TARGET).raw
$(INSTALLED_CONFIGIMAGE_TARGET).raw: $(INSTALLED_CONFIGIMAGE_TARGET) $(SIMG2IMG)
	$(SIMG2IMG) $< $@

.PHONY: $(INSTALLED_FACTORYIMAGE_TARGET).raw
$(INSTALLED_FACTORYIMAGE_TARGET).raw: $(INSTALLED_FACTORYIMAGE_TARGET) $(SIMG2IMG)
	$(SIMG2IMG) $< $@

ifdef INSTALLED_CONFIGIMAGE_TARGET
raw_config := $(INSTALLED_CONFIGIMAGE_TARGET).raw
endif

ifdef INSTALLED_FACTORYIMAGE_TARGET
raw_factory := $(INSTALLED_FACTORYIMAGE_TARGET).raw
endif

ifdef INSTALLED_PRODUCTIMAGE_TARGET
raw_product := $(INSTALLED_PRODUCTIMAGE_TARGET).raw
endif

.PHONY: $(ACRN_GPTIMAGE_BIN)
ifeq ($(strip $(TARGET_USE_TRUSTY)),true)
$(ACRN_GPTIMAGE_BIN): tosimage
tos_bin = $(INSTALLED_TOS_IMAGE_TARGET)
endif

{{#odm-partition}}
ifdef INSTALLED_ODMIMAGE_TARGET
raw_odm := $(INSTALLED_ODMIMAGE_TARGET).raw
$(ACRN_GPTIMAGE_BIN): odmimage $(SIMG2IMG)
	$(SIMG2IMG) $(INSTALLED_ODMIMAGE_TARGET) $(INSTALLED_ODMIMAGE_TARGET).raw
endif
{{/odm-partition}}

{{#acpi-partition}}
ifdef INSTALLED_ACPIIMAGE_TARGET
raw_acpi := $(INSTALLED_ACPIIMAGE_TARGET)
$(ACRN_GPTIMAGE_BIN): acpiimage
endif
{{/acpi-partition}}

{{#acpio-partition}}
ifdef INSTALLED_ACPIOIMAGE_TARGET
raw_acpio := $(INSTALLED_ACPIOIMAGE_TARGET)
$(ACRN_GPTIMAGE_BIN): acpioimage
endif
{{/acpio-partition}}

$(ACRN_GPTIMAGE_BIN): \
	bootloader \
	bootimage \
	{{^slot-ab}}
	recoveryimage \
	cacheimage \
	{{/slot-ab}}
	systemimage \
	{{#avb}}
	vbmetaimage \
	{{/avb}}
    {{#vendor-partition}}
	vendorimage \
    {{/vendor-partition}}
    {{#product-partition}}
	productimage \
    {{/product-partition}}
	$(SIMG2IMG) \
	$(raw_config) \
	$(raw_factory)

	$(hide) rm -f $(INSTALLED_SYSTEMIMAGE).raw
	$(hide) rm -f $(INSTALLED_USERDATAIMAGE_TARGET).raw
	{{^slot-ab}}
	$(hide) rm -f $(INSTALLED_CACHEIMAGE_TARGET).raw
	{{/slot-ab}}

	$(MAKE_EXT4FS_ACRN) \
		-l $(BOARD_USERDATAIMAGE_PARTITION_SIZE) -L data \
		$(PRODUCT_OUT)/userdata.dummy

	$(SIMG2IMG) $(INSTALLED_SYSTEMIMAGE) $(INSTALLED_SYSTEMIMAGE).raw
	{{^slot-ab}}
	$(SIMG2IMG) $(INSTALLED_CACHEIMAGE_TARGET) $(INSTALLED_CACHEIMAGE_TARGET).raw
	{{/slot-ab}}
    {{#vendor-partition}}
	$(SIMG2IMG) $(INSTALLED_VENDORIMAGE_TARGET) $(INSTALLED_VENDORIMAGE_TARGET).raw
    {{/vendor-partition}}
    {{#product-partition}}
	$(SIMG2IMG) $(INSTALLED_PRODUCTIMAGE_TARGET) $(INSTALLED_PRODUCTIMAGE_TARGET).raw
    {{/product-partition}}

	$(INTEL_PATH_BUILD)/create_gpt_image.py \
		--create $@ \
		--block $(BOARD_FLASH_BLOCK_SIZE) \
		--table $(BOARD_GPT_INI) \
		--size $(gptimage_size) \
		--bootloader $(bootloader_bin) \
		--bootloader2 $(bootloader_bin) \
		--tos $(tos_bin) \
		--boot $(INSTALLED_BOOTIMAGE_TARGET) \
		{{^slot-ab}}
		--recovery $(INSTALLED_RECOVERYIMAGE_TARGET) \
		--cache $(INSTALLED_CACHEIMAGE_TARGET).raw \
		{{/slot-ab}}
		{{#avb}}
		--vbmeta $(INSTALLED_VBMETAIMAGE_TARGET) \
		{{/avb}}
		--system $(INSTALLED_SYSTEMIMAGE).raw \
        {{#vendor-partition}}
		--vendor $(INSTALLED_VENDORIMAGE_TARGET).raw \
        {{/vendor-partition}}
        {{#product-partition}}
		--product $(raw_product) \
        {{/product-partition}}
        {{#odm-partition}}
		--odm $(raw_odm) \
        {{/odm-partition}}
        {{#acpi-partition}}
		--acpi $(raw_acpi) \
        {{/acpi-partition}}
        {{#acpio-partition}}
		--acpio $(raw_acpio) \
        {{/acpio-partition}}
		--data $(PRODUCT_OUT)/userdata.dummy \
		--config $(raw_config) \
		--factory $(raw_factory)
