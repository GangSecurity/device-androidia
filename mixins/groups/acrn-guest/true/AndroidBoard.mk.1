######################################################################
# ACRN GPT Image Generation
######################################################################

gptimage_size ?= {{{size}}}

ACRN_DATA_DIR = $(PRODUCT_OUT)/data_partition
ACRN_AND_DIR = $(ACRN_DATA_DIR)/android
ACRN_GUEST_DIR = $(PRODUCT_OUT)/acrn_guest
ACRN_GUEST_IMAGES_DIR = $(PRODUCT_OUT)/acrn_guest/IMAGES
ACRN_GPT_BIN = $(ACRN_AND_DIR)/android.img
ACRN_DATA_SIZE ?= {{{data_size}}}
MAKE_EXT4FS_ACRN = $(TARGET_DEVICE_DIR)/make_ext4fs

raw_config := none
raw_factory := none
tos_bin := none
raw_product := none
raw_odm := none
raw_acpi := none
raw_acpio := none

.PHONY: none
none: ;

.PHONY: $(INSTALLED_CONFIGIMAGE_TARGET).raw
$(INSTALLED_CONFIGIMAGE_TARGET).raw: $(INSTALLED_CONFIGIMAGE_TARGET) $(SIMG2IMG)
	$(SIMG2IMG) $< $@

.PHONY: $(INSTALLED_FACTORYIMAGE_TARGET).raw
$(INSTALLED_FACTORYIMAGE_TARGET).raw: $(INSTALLED_FACTORYIMAGE_TARGET) $(SIMG2IMG)
	$(SIMG2IMG) $< $@

ifdef INSTALLED_CONFIGIMAGE_TARGET
raw_config := $(INSTALLED_CONFIGIMAGE_TARGET).raw
endif

ifdef INSTALLED_FACTORYIMAGE_TARGET
raw_factory := $(INSTALLED_FACTORYIMAGE_TARGET).raw
endif

ifdef INSTALLED_PRODUCTIMAGE_TARGET
raw_product := $(INSTALLED_PRODUCTIMAGE_TARGET).raw
endif

.PHONY: $(ACRN_GPTIMAGE_BIN)
ifeq ($(strip $(TARGET_USE_TRUSTY)),true)
tos_bin = $(ACRN_GUEST_IMAGES_DIR)/tos.img
endif

{{#odm-partition}}
ifdef INSTALLED_ODMIMAGE_TARGET
raw_odm := $(INSTALLED_ODMIMAGE_TARGET).raw
$(ACRN_GPTIMAGE_BIN): odmimage $(SIMG2IMG)
	$(SIMG2IMG) $(INSTALLED_ODMIMAGE_TARGET) $(INSTALLED_ODMIMAGE_TARGET).raw
endif
{{/odm-partition}}

{{#acpi-partition}}
ifdef INSTALLED_ACPIIMAGE_TARGET
raw_acpi := $(INSTALLED_ACPIIMAGE_TARGET)
endif
{{/acpi-partition}}

{{#acpio-partition}}
ifdef INSTALLED_ACPIOIMAGE_TARGET
raw_acpio := $(INSTALLED_ACPIOIMAGE_TARGET)
endif
{{/acpio-partition}}

$(ACRN_GPTIMAGE_BIN): \
	target-files-package \
	{{^slot-ab}}
	cacheimage \
	{{/slot-ab}}
	$(SIMG2IMG) \
	$(raw_config) \
	$(raw_factory)

	rm -rf $(ACRN_GUEST_DIR)
	mkdir $(ACRN_GUEST_DIR)
	unzip $(BUILT_TARGET_FILES_PACKAGE) IMAGES/* -d $(ACRN_GUEST_DIR)
	$(hide) rm -f $(ACRN_GUEST_IMAGES_DIR)/system.img.raw
	$(hide) rm -f $(INSTALLED_USERDATAIMAGE_TARGET).raw
	{{^slot-ab}}
	$(hide) rm -f $(INSTALLED_CACHEIMAGE_TARGET).raw
	{{/slot-ab}}

	$(SIMG2IMG) $(ACRN_GUEST_IMAGES_DIR)/system.img $(ACRN_GUEST_IMAGES_DIR)/system.img.raw
	{{^slot-ab}}
	$(SIMG2IMG) $(INSTALLED_CACHEIMAGE_TARGET) $(INSTALLED_CACHEIMAGE_TARGET).raw
	{{/slot-ab}}
    {{#vendor-partition}}
	$(SIMG2IMG) $(ACRN_GUEST_IMAGES_DIR)/vendor.img $(ACRN_GUEST_IMAGES_DIR)/vendor.img.raw
    {{/vendor-partition}}
    {{#product-partition}}
	$(SIMG2IMG) $(ACRN_GUEST_IMAGES_DIR)/product.img $(ACRN_GUEST_IMAGES_DIR)/product.img.raw
    {{/product-partition}}

	$(INTEL_PATH_BUILD)/create_gpt_image.py \
		--create $@ \
		--block $(BOARD_FLASH_BLOCK_SIZE) \
		--table $(BOARD_GPT_INI) \
		--size $(gptimage_size) \
		--bootloader $(bootloader_bin) \
		--bootloader2 $(bootloader_bin) \
		--tos $(tos_bin) \
		--boot $(ACRN_GUEST_IMAGES_DIR)/boot.img \
		{{^slot-ab}}
		--recovery $(ACRN_GUEST_IMAGES_DIR)/recovery.img \
		--cache $(INSTALLED_CACHEIMAGE_TARGET).raw \
		{{/slot-ab}}
		{{#avb}}
		--vbmeta $(ACRN_GUEST_IMAGES_DIR)/vbmeta.img \
		{{/avb}}
		--system $(ACRN_GUEST_IMAGES_DIR)/system.img.raw \
        {{#vendor-partition}}
		--vendor $(ACRN_GUEST_IMAGES_DIR)/vendor.img.raw \
        {{/vendor-partition}}
        {{#product-partition}}
		--product $(ACRN_GUEST_IMAGES_DIR)/product.img.raw \
        {{/product-partition}}
        {{#odm-partition}}
		--odm $(raw_odm) \
        {{/odm-partition}}
        {{#acpi-partition}}
		--acpi $(raw_acpi) \
        {{/acpi-partition}}
        {{#acpio-partition}}
		--acpio $(raw_acpio) \
        {{/acpio-partition}}
		--config $(raw_config) \
		--factory $(raw_factory)
